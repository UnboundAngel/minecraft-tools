<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>End Dimension Planner - Minecraft Tools</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(180deg, #05000b 0%, #1b0133 50%, #0c0016 100%);
            color: #e0d5ff;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* End particles background */
        .end-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 1;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(176, 68, 255, 0.4);
            box-shadow: 0 0 8px rgba(176, 68, 255, 0.6);
            animation: float-up 15s infinite;
        }

        @keyframes float-up {
            0% {
                transform: translateY(100vh) translateX(0) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) translateX(var(--drift)) rotate(360deg);
                opacity: 0;
            }
        }

        /* Main container */
        #end-planner {
            position: relative;
            z-index: 10;
            display: grid;
            grid-template-columns: 280px 1fr 400px;
            gap: 1.5rem;
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
            min-height: 100vh;
        }

        /* Panel styling */
        .planner-panel {
            background: rgba(11, 0, 22, 0.8);
            border: 2px solid #b044ff;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(176, 68, 255, 0.3), inset 0 0 20px rgba(176, 68, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        /* LEFT PANEL - Navigation */
        .planner-left-panel {
            background: rgba(11, 0, 22, 0.8);
            border: 2px solid #b044ff;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(176, 68, 255, 0.3);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .current-date {
            text-align: center;
            padding: 1rem;
            background: linear-gradient(135deg, rgba(176, 68, 255, 0.2), rgba(233, 140, 255, 0.2));
            border: 1px solid #b044ff;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(176, 68, 255, 0.3);
        }

        .date-day {
            font-size: 2.5rem;
            font-weight: bold;
            color: #e98cff;
            text-shadow: 0 0 10px rgba(233, 140, 255, 0.8);
            letter-spacing: 2px;
        }

        .date-info {
            font-size: 0.9rem;
            color: #b8a0ff;
            margin-top: 0.5rem;
        }

        .timeline-label {
            font-size: 0.8rem;
            color: #b8a0ff;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }

        .timeline {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding-right: 0.5rem;
        }

        .timeline::-webkit-scrollbar {
            width: 6px;
        }

        .timeline::-webkit-scrollbar-track {
            background: rgba(176, 68, 255, 0.1);
            border-radius: 3px;
        }

        .timeline::-webkit-scrollbar-thumb {
            background: rgba(176, 68, 255, 0.5);
            border-radius: 3px;
        }

        .day-pill {
            padding: 0.75rem 1rem;
            background: rgba(176, 68, 255, 0.1);
            border: 1px solid rgba(176, 68, 255, 0.3);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .day-pill:hover {
            background: rgba(176, 68, 255, 0.2);
            border-color: #b044ff;
            transform: translateX(4px);
        }

        .day-pill.active {
            background: rgba(233, 140, 255, 0.3);
            border-color: #e98cff;
            box-shadow: 0 0 12px rgba(233, 140, 255, 0.5);
            font-weight: bold;
        }

        .nav-buttons {
            display: flex;
            gap: 0.75rem;
        }

        .nav-btn {
            flex: 1;
            padding: 0.75rem;
            background: linear-gradient(135deg, #b044ff, #8833cc);
            border: none;
            border-radius: 4px;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(176, 68, 255, 0.4);
        }

        .nav-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #e98cff, #b044ff);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(233, 140, 255, 0.6);
        }

        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
        }

        /* CENTER PANEL - Journal */
        .planner-center-panel {
            background: rgba(11, 0, 22, 0.8);
            border: 2px solid #b044ff;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(176, 68, 255, 0.3);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .journal-title {
            font-size: 1.8rem;
            font-weight: bold;
            color: #e98cff;
            background: transparent;
            border: none;
            border-bottom: 2px solid rgba(176, 68, 255, 0.5);
            padding: 0.5rem;
            outline: none;
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 8px rgba(233, 140, 255, 0.6);
        }

        .journal-title::placeholder {
            color: rgba(233, 140, 255, 0.4);
        }

        .journal-body {
            flex: 1;
            min-height: 400px;
            padding: 1rem;
            background: rgba(5, 0, 11, 0.5);
            border: 1px solid rgba(176, 68, 255, 0.3);
            border-radius: 4px;
            color: #e0d5ff;
            font-size: 1rem;
            line-height: 1.8;
            outline: none;
            overflow-y: auto;
        }

        .journal-body:focus {
            border-color: #b044ff;
            box-shadow: 0 0 12px rgba(176, 68, 255, 0.4);
        }

        .journal-body:empty::before {
            content: 'Write your ender log here...\A\AURLs will automatically become clickable.';
            color: rgba(176, 68, 255, 0.4);
            white-space: pre-wrap;
        }

        .journal-body a {
            color: #7de8ff;
            text-decoration: underline;
            cursor: pointer;
        }

        .journal-body a:hover {
            color: #a0f0ff;
            text-shadow: 0 0 8px rgba(125, 232, 255, 0.6);
        }

        .journal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid rgba(176, 68, 255, 0.3);
            font-size: 0.85rem;
            color: #b8a0ff;
        }

        .char-count {
            font-weight: bold;
            color: #e98cff;
        }

        /* RIGHT PANEL - Todos */
        .planner-right-panel {
            background: rgba(11, 0, 22, 0.8);
            border: 2px solid #b044ff;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(176, 68, 255, 0.3);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .todo-header {
            font-size: 1.5rem;
            font-weight: bold;
            color: #e98cff;
            text-align: center;
            text-shadow: 0 0 10px rgba(233, 140, 255, 0.8);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .quick-add-container {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .quick-add-input {
            flex: 1;
            padding: 0.75rem;
            background: rgba(5, 0, 11, 0.6);
            border: 1px solid rgba(176, 68, 255, 0.5);
            border-radius: 4px;
            color: #e0d5ff;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            outline: none;
            transition: all 0.2s ease;
        }

        .quick-add-input:focus {
            border-color: #b044ff;
            box-shadow: 0 0 12px rgba(176, 68, 255, 0.4);
        }

        .quick-add-input::placeholder {
            color: rgba(176, 68, 255, 0.5);
        }

        .quick-add-btn {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #44ff88, #22cc66);
            border: none;
            border-radius: 50%;
            color: #000;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(68, 255, 136, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quick-add-btn:hover {
            background: linear-gradient(135deg, #66ffaa, #44ff88);
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(68, 255, 136, 0.6);
        }

        .todos-container {
            flex: 1;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .todos-container::-webkit-scrollbar {
            width: 6px;
        }

        .todos-container::-webkit-scrollbar-track {
            background: rgba(176, 68, 255, 0.1);
            border-radius: 3px;
        }

        .todos-container::-webkit-scrollbar-thumb {
            background: rgba(176, 68, 255, 0.5);
            border-radius: 3px;
        }

        .todo-section {
            margin-bottom: 1.5rem;
        }

        .todo-section-title {
            font-size: 0.8rem;
            color: #b8a0ff;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.75rem;
            opacity: 0.8;
        }

        .todo-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .todo-item {
            background: rgba(176, 68, 255, 0.1);
            border: 1px solid rgba(176, 68, 255, 0.3);
            border-radius: 4px;
            padding: 0.75rem;
            animation: taskSlideIn 0.3s ease;
            transition: all 0.2s ease;
        }

        @keyframes taskSlideIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .todo-item:hover {
            background: rgba(176, 68, 255, 0.15);
            border-color: #b044ff;
        }

        .todo-item.completed {
            opacity: 0.6;
        }

        .todo-main {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .todo-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            flex-shrink: 0;
            margin-top: 2px;
            accent-color: #44ff88;
        }

        .todo-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .todo-text {
            color: #e0d5ff;
            font-size: 0.95rem;
            line-height: 1.4;
            word-wrap: break-word;
            cursor: text;
        }

        .todo-text[contenteditable="true"] {
            outline: 1px solid #b044ff;
            padding: 4px;
            border-radius: 2px;
            background: rgba(176, 68, 255, 0.1);
        }

        .todo-item.completed .todo-text {
            text-decoration: line-through;
            color: #8866aa;
        }

        .todo-meta {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .priority-badge {
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .priority-high {
            background: #ff4466;
            color: #fff;
        }

        .priority-normal {
            background: #ffaa44;
            color: #000;
        }

        .priority-low {
            background: #44ff88;
            color: #000;
        }

        .subtasks-container {
            margin-top: 0.5rem;
            padding-left: 1.5rem;
            border-left: 2px solid rgba(176, 68, 255, 0.3);
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .subtask-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem;
            font-size: 0.85rem;
        }

        .subtask-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #44ff88;
        }

        .subtask-text {
            flex: 1;
            color: #c0b0dd;
        }

        .subtask-item.completed .subtask-text {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .todo-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .action-btn {
            padding: 0.25rem 0.75rem;
            background: rgba(176, 68, 255, 0.2);
            border: 1px solid rgba(176, 68, 255, 0.4);
            border-radius: 3px;
            color: #b8a0ff;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            background: rgba(176, 68, 255, 0.3);
            border-color: #b044ff;
            color: #e98cff;
        }

        .delete-btn {
            background: rgba(255, 68, 102, 0.2);
            border-color: rgba(255, 68, 102, 0.4);
        }

        .delete-btn:hover {
            background: rgba(255, 68, 102, 0.3);
            border-color: #ff4466;
        }

        .completed-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(176, 68, 255, 0.3);
        }

        .completed-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            color: #b8a0ff;
            font-size: 0.85rem;
            margin-bottom: 0.75rem;
            user-select: none;
        }

        .completed-toggle:hover {
            color: #e98cff;
        }

        .completed-list {
            display: none;
        }

        .completed-list.show {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            #end-planner {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .planner-left-panel {
                max-height: 300px;
            }

            .timeline {
                flex-direction: row;
                overflow-x: auto;
            }

            .day-pill {
                white-space: nowrap;
            }
        }

        /* Page transition animation */
        .page-transition {
            animation: pageSlide 0.3s ease;
        }

        @keyframes pageSlide {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>
</head>
<body>
    <!-- End particles background -->
    <div class="end-particles" id="endParticles"></div>

    <!-- Main planner container -->
    <div id="end-planner">
        <!-- LEFT PANEL - Navigation -->
        <div class="planner-left-panel">
            <div class="current-date">
                <div class="date-day" id="currentDay">DAY 1</div>
                <div class="date-info" id="currentDate">Loading...</div>
            </div>

            <div class="timeline-label">Timeline</div>
            <div class="timeline" id="timeline">
                <!-- Day pills populated by JS -->
            </div>

            <div class="nav-buttons">
                <button class="nav-btn" id="prevBtn" onclick="navigatePrev()">â¬… Prev</button>
                <button class="nav-btn" id="nextBtn" onclick="navigateNext()">Next âž¡</button>
            </div>
        </div>

        <!-- CENTER PANEL - Journal -->
        <div class="planner-center-panel">
            <input type="text" class="journal-title" id="journalTitle" placeholder="Ender Log Title" />

            <div class="journal-body" contenteditable="true" id="journalBody"></div>

            <div class="journal-footer">
                <span class="char-count" id="charCount">0 characters</span>
                <span>URLs become clickable links</span>
            </div>
        </div>

        <!-- RIGHT PANEL - Todos -->
        <div class="planner-right-panel">
            <div class="todo-header">End Tasks</div>

            <div class="quick-add-container">
                <input type="text" class="quick-add-input" id="quickAddInput" placeholder="Add a task..." />
                <button class="quick-add-btn" id="quickAddBtn" onclick="addTask()">+</button>
            </div>

            <div class="todos-container">
                <div class="todo-section">
                    <div class="todo-section-title">Active Tasks</div>
                    <div class="todo-list" id="activeTodos">
                        <!-- Active todos populated by JS -->
                    </div>
                </div>

                <div class="completed-section">
                    <div class="completed-toggle" onclick="toggleCompleted()">
                        <span id="completedToggleIcon">â–¶</span>
                        <span>Completed (<span id="completedCount">0</span>)</span>
                    </div>
                    <div class="completed-list" id="completedList">
                        <!-- Completed todos populated by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // STATE & CONFIGURATION
        // ============================================
        const STORAGE_KEY = 'mcTools_endPlanner_v1';
        let pages = [];
        let currentPageIndex = 0;
        let showCompleted = false;

        // ============================================
        // INITIALIZATION
        // ============================================
        window.addEventListener('DOMContentLoaded', function() {
            initPlanner();
        });

        function initPlanner() {
            createEndParticles();
            loadState();
            bindEventListeners();
            renderCurrentPage();
        }

        // ============================================
        // PARTICLES
        // ============================================
        function createEndParticles() {
            const container = document.getElementById('endParticles');
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.setProperty('--drift', (Math.random() * 100 - 50) + 'px');
                particle.style.animationDelay = Math.random() * 15 + 's';
                particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
                container.appendChild(particle);
            }
        }

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        function loadState() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    pages = JSON.parse(saved);
                } catch (e) {
                    console.error('Failed to parse saved state:', e);
                    pages = [];
                }
            }

            // Create default page if none exist
            if (pages.length === 0) {
                pages = [{
                    id: Date.now().toString(),
                    date: new Date().toISOString().split('T')[0],
                    title: '',
                    body: '',
                    todos: []
                }];
            }

            currentPageIndex = 0;
        }

        function saveState() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(pages));
            } catch (e) {
                console.error('Failed to save state:', e);
            }
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        function bindEventListeners() {
            const journalTitle = document.getElementById('journalTitle');
            const journalBody = document.getElementById('journalBody');
            const quickAddInput = document.getElementById('quickAddInput');

            // Journal title input
            journalTitle.addEventListener('input', function() {
                pages[currentPageIndex].title = this.value;
                updateCharCount();
                saveState();
            });

            // Journal body input
            journalBody.addEventListener('input', function() {
                pages[currentPageIndex].body = this.innerHTML;
                updateCharCount();
                saveState();
            });

            // Linkify on blur
            journalBody.addEventListener('blur', function() {
                linkifyJournalBody();
            });

            // Prevent default link behavior in contenteditable
            journalBody.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    e.preventDefault();
                    window.open(e.target.href, '_blank', 'noopener,noreferrer');
                }
            });

            // Quick add input - Enter key
            quickAddInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addTask();
                }
            });
        }

        // ============================================
        // NAVIGATION
        // ============================================
        function navigatePrev() {
            if (currentPageIndex > 0) {
                currentPageIndex--;
                renderCurrentPage();
            }
        }

        function navigateNext() {
            if (currentPageIndex >= pages.length - 1) {
                // Create new page
                const newPage = {
                    id: Date.now().toString(),
                    date: new Date().toISOString().split('T')[0],
                    title: '',
                    body: '',
                    todos: []
                };
                pages.push(newPage);
                saveState();
            }
            currentPageIndex++;
            renderCurrentPage();
        }

        function goToPage(index) {
            if (index >= 0 && index < pages.length) {
                currentPageIndex = index;
                renderCurrentPage();
            }
        }

        // ============================================
        // RENDERING
        // ============================================
        function renderCurrentPage() {
            const page = pages[currentPageIndex];

            // Add transition animation
            const centerPanel = document.querySelector('.planner-center-panel');
            centerPanel.classList.remove('page-transition');
            void centerPanel.offsetWidth; // Force reflow
            centerPanel.classList.add('page-transition');

            // Update date display
            updateDateDisplay();

            // Update timeline
            renderTimeline();

            // Update navigation buttons
            updateNavButtons();

            // Update journal
            document.getElementById('journalTitle').value = page.title || '';
            document.getElementById('journalBody').innerHTML = page.body || '';
            updateCharCount();

            // Update todos
            renderTodos();
        }

        function updateDateDisplay() {
            const page = pages[currentPageIndex];
            const dateObj = new Date(page.date);

            document.getElementById('currentDay').textContent = `DAY ${currentPageIndex + 1}`;

            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = dateObj.toLocaleDateString('en-US', options);
        }

        function renderTimeline() {
            const timeline = document.getElementById('timeline');
            timeline.innerHTML = '';

            pages.forEach((page, index) => {
                const pill = document.createElement('div');
                pill.className = 'day-pill' + (index === currentPageIndex ? ' active' : '');

                const dateObj = new Date(page.date);
                const dateStr = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                pill.textContent = `Day ${index + 1} - ${dateStr}`;
                pill.onclick = () => goToPage(index);

                timeline.appendChild(pill);
            });
        }

        function updateNavButtons() {
            document.getElementById('prevBtn').disabled = currentPageIndex === 0;
            document.getElementById('nextBtn').disabled = false; // Next always creates new page if needed
        }

        // ============================================
        // CHARACTER COUNTING
        // ============================================
        function updateCharCount() {
            const title = document.getElementById('journalTitle').value;
            const body = document.getElementById('journalBody').innerText;

            const titleChars = title.trim().length;
            const bodyChars = body.trim().length;
            const total = titleChars + bodyChars;

            document.getElementById('charCount').textContent = `${total} character${total !== 1 ? 's' : ''}`;
        }

        // ============================================
        // LINKIFY
        // ============================================
        function linkifyJournalBody() {
            const body = document.getElementById('journalBody');
            const selection = window.getSelection();
            const range = selection.rangeCount > 0 ? selection.getRangeAt(0) : null;

            let html = body.innerHTML;

            // URL regex
            const urlRegex = /(?<!["'>])(https?:\/\/[^\s<]+)(?![^<]*<\/a>)/gi;

            html = html.replace(urlRegex, function(url) {
                return `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`;
            });

            if (html !== body.innerHTML) {
                body.innerHTML = html;
                pages[currentPageIndex].body = html;
                saveState();

                // Restore cursor position
                if (range) {
                    try {
                        selection.removeAllRanges();
                        selection.addRange(range);
                    } catch (e) {
                        // Ignore errors
                    }
                }
            }
        }

        // ============================================
        // TODO MANAGEMENT
        // ============================================
        function addTask() {
            const input = document.getElementById('quickAddInput');
            const text = input.value.trim();

            if (!text) return;

            const newTodo = {
                id: Date.now().toString(),
                text: text,
                done: false,
                createdAt: Date.now(),
                dueDate: null,
                priority: null,
                subtasks: []
            };

            pages[currentPageIndex].todos.push(newTodo);
            input.value = '';

            saveState();
            renderTodos();
        }

        function toggleTodo(todoId) {
            const page = pages[currentPageIndex];
            const todo = page.todos.find(t => t.id === todoId);

            if (todo) {
                todo.done = !todo.done;
                saveState();
                renderTodos();
            }
        }

        function deleteTodo(todoId) {
            const page = pages[currentPageIndex];
            page.todos = page.todos.filter(t => t.id !== todoId);

            saveState();
            renderTodos();
        }

        function updateTodoText(todoId, newText) {
            const page = pages[currentPageIndex];
            const todo = page.todos.find(t => t.id === todoId);

            if (todo) {
                todo.text = newText;
                saveState();
            }
        }

        function setPriority(todoId, priority) {
            const page = pages[currentPageIndex];
            const todo = page.todos.find(t => t.id === todoId);

            if (todo) {
                todo.priority = priority;
                saveState();
                renderTodos();
            }
        }

        function addSubtask(todoId) {
            const page = pages[currentPageIndex];
            const todo = page.todos.find(t => t.id === todoId);

            if (todo) {
                const text = prompt('Enter subtask:');
                if (text && text.trim()) {
                    todo.subtasks.push({
                        id: Date.now().toString(),
                        text: text.trim(),
                        done: false
                    });
                    saveState();
                    renderTodos();
                }
            }
        }

        function toggleSubtask(todoId, subtaskId) {
            const page = pages[currentPageIndex];
            const todo = page.todos.find(t => t.id === todoId);

            if (todo) {
                const subtask = todo.subtasks.find(s => s.id === subtaskId);
                if (subtask) {
                    subtask.done = !subtask.done;
                    saveState();
                    renderTodos();
                }
            }
        }

        function deleteSubtask(todoId, subtaskId) {
            const page = pages[currentPageIndex];
            const todo = page.todos.find(t => t.id === todoId);

            if (todo) {
                todo.subtasks = todo.subtasks.filter(s => s.id !== subtaskId);
                saveState();
                renderTodos();
            }
        }

        function moveTodoUp(todoId) {
            const page = pages[currentPageIndex];
            const index = page.todos.findIndex(t => t.id === todoId);

            if (index > 0) {
                [page.todos[index], page.todos[index - 1]] = [page.todos[index - 1], page.todos[index]];
                saveState();
                renderTodos();
            }
        }

        function moveTodoDown(todoId) {
            const page = pages[currentPageIndex];
            const index = page.todos.findIndex(t => t.id === todoId);

            if (index >= 0 && index < page.todos.length - 1) {
                [page.todos[index], page.todos[index + 1]] = [page.todos[index + 1], page.todos[index]];
                saveState();
                renderTodos();
            }
        }

        function renderTodos() {
            const page = pages[currentPageIndex];
            const activeTodos = page.todos.filter(t => !t.done);
            const completedTodos = page.todos.filter(t => t.done);

            // Render active todos
            const activeContainer = document.getElementById('activeTodos');
            activeContainer.innerHTML = '';

            activeTodos.forEach((todo, index) => {
                activeContainer.appendChild(createTodoElement(todo, index, activeTodos.length));
            });

            if (activeTodos.length === 0) {
                activeContainer.innerHTML = '<div style="color: #8866aa; font-size: 0.85rem; text-align: center; padding: 1rem;">No active tasks</div>';
            }

            // Render completed todos
            const completedContainer = document.getElementById('completedList');
            completedContainer.innerHTML = '';

            completedTodos.forEach(todo => {
                completedContainer.appendChild(createTodoElement(todo, -1, -1));
            });

            // Update completed count
            document.getElementById('completedCount').textContent = completedTodos.length;
        }

        function createTodoElement(todo, index, total) {
            const item = document.createElement('div');
            item.className = 'todo-item' + (todo.done ? ' completed' : '');

            const main = document.createElement('div');
            main.className = 'todo-main';

            // Checkbox
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'todo-checkbox';
            checkbox.checked = todo.done;
            checkbox.onchange = () => toggleTodo(todo.id);

            // Content
            const content = document.createElement('div');
            content.className = 'todo-content';

            // Text
            const text = document.createElement('div');
            text.className = 'todo-text';
            text.textContent = todo.text;
            text.onclick = function() {
                if (!todo.done) {
                    this.contentEditable = 'true';
                    this.focus();
                }
            };
            text.onblur = function() {
                this.contentEditable = 'false';
                updateTodoText(todo.id, this.textContent);
            };
            text.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.blur();
                }
            };

            content.appendChild(text);

            // Meta (priority)
            if (todo.priority && !todo.done) {
                const meta = document.createElement('div');
                meta.className = 'todo-meta';

                const badge = document.createElement('span');
                badge.className = `priority-badge priority-${todo.priority}`;
                badge.textContent = todo.priority;
                meta.appendChild(badge);

                content.appendChild(meta);
            }

            // Subtasks
            if (todo.subtasks && todo.subtasks.length > 0) {
                const subtasksContainer = document.createElement('div');
                subtasksContainer.className = 'subtasks-container';

                todo.subtasks.forEach(subtask => {
                    const subtaskItem = document.createElement('div');
                    subtaskItem.className = 'subtask-item' + (subtask.done ? ' completed' : '');

                    const subtaskCheck = document.createElement('input');
                    subtaskCheck.type = 'checkbox';
                    subtaskCheck.className = 'subtask-checkbox';
                    subtaskCheck.checked = subtask.done;
                    subtaskCheck.onchange = () => toggleSubtask(todo.id, subtask.id);

                    const subtaskText = document.createElement('span');
                    subtaskText.className = 'subtask-text';
                    subtaskText.textContent = subtask.text;

                    const subtaskDelete = document.createElement('button');
                    subtaskDelete.className = 'action-btn delete-btn';
                    subtaskDelete.textContent = 'Ã—';
                    subtaskDelete.onclick = () => deleteSubtask(todo.id, subtask.id);

                    subtaskItem.appendChild(subtaskCheck);
                    subtaskItem.appendChild(subtaskText);
                    subtaskItem.appendChild(subtaskDelete);

                    subtasksContainer.appendChild(subtaskItem);
                });

                content.appendChild(subtasksContainer);
            }

            // Actions (only for active todos)
            if (!todo.done) {
                const actions = document.createElement('div');
                actions.className = 'todo-actions';

                // Priority buttons
                const priorityHigh = document.createElement('button');
                priorityHigh.className = 'action-btn';
                priorityHigh.textContent = 'ðŸ”´ High';
                priorityHigh.onclick = () => setPriority(todo.id, 'high');

                const priorityNormal = document.createElement('button');
                priorityNormal.className = 'action-btn';
                priorityNormal.textContent = 'ðŸŸ¡ Normal';
                priorityNormal.onclick = () => setPriority(todo.id, 'normal');

                const priorityLow = document.createElement('button');
                priorityLow.className = 'action-btn';
                priorityLow.textContent = 'ðŸŸ¢ Low';
                priorityLow.onclick = () => setPriority(todo.id, 'low');

                // Add subtask button
                const addSubtaskBtn = document.createElement('button');
                addSubtaskBtn.className = 'action-btn';
                addSubtaskBtn.textContent = '+ Subtask';
                addSubtaskBtn.onclick = () => addSubtask(todo.id);

                // Move buttons (only if not in completed section)
                if (index >= 0) {
                    if (index > 0) {
                        const upBtn = document.createElement('button');
                        upBtn.className = 'action-btn';
                        upBtn.textContent = 'â†‘';
                        upBtn.onclick = () => moveTodoUp(todo.id);
                        actions.appendChild(upBtn);
                    }

                    if (index < total - 1) {
                        const downBtn = document.createElement('button');
                        downBtn.className = 'action-btn';
                        downBtn.textContent = 'â†“';
                        downBtn.onclick = () => moveTodoDown(todo.id);
                        actions.appendChild(downBtn);
                    }
                }

                actions.appendChild(priorityHigh);
                actions.appendChild(priorityNormal);
                actions.appendChild(priorityLow);
                actions.appendChild(addSubtaskBtn);

                // Delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'action-btn delete-btn';
                deleteBtn.textContent = 'ðŸ—‘ Delete';
                deleteBtn.onclick = () => {
                    if (confirm('Delete this task?')) {
                        deleteTodo(todo.id);
                    }
                };
                actions.appendChild(deleteBtn);

                content.appendChild(actions);
            }

            main.appendChild(checkbox);
            main.appendChild(content);
            item.appendChild(main);

            return item;
        }

        function toggleCompleted() {
            showCompleted = !showCompleted;
            const list = document.getElementById('completedList');
            const icon = document.getElementById('completedToggleIcon');

            if (showCompleted) {
                list.classList.add('show');
                icon.textContent = 'â–¼';
            } else {
                list.classList.remove('show');
                icon.textContent = 'â–¶';
            }
        }
    </script>
</body>
</html>
